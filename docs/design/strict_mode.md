# 環境分離のためのファイルアクセス制限モード

- URL: https://github.com/sacloud/autoscaler/issues/274
- Author: @yamamoto-febc

## 概要

Coreのインスタンスを同一環境で複数稼働させる場合、
設定ファイルから外部ファイルを読み込む機能がオンだとコンフィギュレーションの中身まで考慮して環境分離する必要が出てくる。

例えばマルチテナントにおいてテナントごとに動的にコンフィギュレーションを生成する場合、
他テナントのファイルにアクセスしないコンフィギュレーションとなっているか確認する必要がある。
これは煩雑なためAutoScaler側でなんらかの対策をしておきたい。

Dockerなどのコンテナを用いてCoreのインスタンスを稼働させる環境を分離してしまう方法もあるが、
AutoScaler側が最低限の機能を提供することで動かせる環境の選択肢を増やしておきたい。

## 前提: Coreからの外部ファイルへのアクセス

Coreのインスタンスが外部ファイルにアクセスするパターンは以下とおり。

- コンフィギュレーション内の`StringOrFilePath`型の項目で指定されたファイルパスへのRead
- コンフィギュレーション内でのTLS関連設定で指定されたファイルパスへのRead
- カスタムハンドラがUNIXドメインソケット上でリッスンする場合のソケットファイルへのRead/Write
- CoreのgRPCサーバがUNIXドメインソケット上でリッスンする場合のソケットファイルへのRead/Write
- ライブラリ経由
  - libsacloudのプロファイル機能での設定ファイルのRead

## 実装方針

#### 実装すること

- コンフィギュレーションでの外部ファイルのインクルードを制限する
- libsacloudのプロファイル機能を制限する
- Exporterの設定を制限する

#### 実装しないこと

- Coreのリッスンアドレスなどの起動オプションで指定される項目の制限

## 実装

- Coreの起動オプションで`--strict-file-access`を指定することで外部ファイルの読み込みを制御する
- `StringOrFilePath`でフラグに応じてファイルパスが指定された場合の警告やエラーを出す
- フラグに応じてコンフィギュレーションでカスタムハンドラが指定された場合の警告やエラーを出す
- libsacloudのAPIクライアント作成処理でフラグに応じてプロファイル機能をON/OFFする

### コンフィギュレーションでの制限対象項目

- `StringOrFilePath`型の項目全て
- TLS関連の項目
  - 現在string型になっているのを`StringOrFilePath`に修正
- カスタムハンドラの定義
- Exporterの設定

